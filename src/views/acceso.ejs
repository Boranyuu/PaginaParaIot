<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Acceso IoT</title>
  <link rel="stylesheet" href="/css/styles.css" />
</head>
<body>
  <nav class="navbar">
    <div id="Kalacam">
      <img src="/assets/imagen.jpeg" alt="Logo" />
      <h2>Kalacam Security</h2>
    </div>
    <div id="salir">
      <a href="/" class="btn-salir">Cerrar Sesión</a>
    </div>
  </nav>

  <div id="contenedor-principal">
    <div id="alert-edicion" class="alert-container"></div>

    <!-- Usuarios -->
    <section id="seccion-usuarios">
      <h2>Lista de Usuarios</h2>
      <table id="usuarios-table">
        <thead>
          <tr><th>ID</th><th>Nombre</th><th>Apellido</th><th>Email</th><th>Acciones</th></tr>
        </thead>
        <tbody>
          <% if (usuarios.length > 0) { %>
            <% usuarios.forEach(u => { %>
              <tr>
                <td><%= u.id %></td>
                <td><%= u.nombre %></td>
                <td><%= u.apellido %></td>
                <td><%= u.email %></td>
                <td>
                  <button onclick="mostrarEdicion(<%= u.id %>, '<%= (u.nombre || '').replace(/'/g,"\\'") %>', '<%= (u.apellido || '').replace(/'/g,"\\'") %>', '<%= (u.email || '').replace(/'/g,"\\'") %>')">Editar</button>
                  <button onclick="eliminarUsuario(<%= u.id %>)">Eliminar</button>
                </td>
              </tr>
            <% }) %>
          <% } else { %>
            <tr><td colspan="5">No hay usuarios disponibles</td></tr>
          <% } %>
        </tbody>
      </table>
    </section>

    <!-- Historial -->
    <section id="seccion-historial">
      <h2>Historial de Acciones</h2>
      <table id="historial-table">
        <thead>
          <tr><th>ID</th><th>Acción</th><th>Método</th><th>Endpoint</th><th>IP</th><th>User Agent</th><th>Fecha</th></tr>
        </thead>
        <tbody>
          <% if (historial.length > 0) { %>
            <% historial.forEach(h => { %>
              <tr>
                <td><%= h.id %></td>
                <td><%= h.accion %></td>
                <td><%= h.metodo %></td>
                <td><%= h.endpoint %></td>
                <td><%= h.ip %></td>
                <td><%= h.user_agent %></td>
                <td><%= h.fecha %></td>
              </tr>
            <% }) %>
          <% } else { %>
            <tr><td colspan="7">No hay historial disponible</td></tr>
          <% } %>
        </tbody>
      </table>
    </section>
  </div>

  <script>
    window.TOKEN = "<%= token %>";
    window.API_URL = "<%= apiUrl %>";
    window.HEADERS_AUTH = {
      "Authorization": `Bearer ${window.TOKEN}`,
      "Content-Type": "application/json"
    };
  </script>
  <script src="/js/historial.js"></script>
</body>
</html>
